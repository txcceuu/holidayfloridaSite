<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orlando Itinerary Creator - Multi-Day</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f8; /* Light gray background */
            color: #333;
        }

        .nav-item {
            transition: color 0.3s ease;
        }

            .nav-item:hover {
                color: #FF7043;
            }

        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #ffffff;
        }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            }

        .section-title {
            border-bottom: 3px solid #FF7043;
            padding-bottom: 0.5rem;
            display: inline-block;
        }

        .button-primary {
            background-color: #FF7043;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }

            .button-primary:hover {
                background-color: #E65100; /* Darker orange */
            }

        .button-secondary {
            background-color: #6c757d;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }

            .button-secondary:hover {
                background-color: #5a6268;
            }

        .button-danger {
            background-color: #dc3545;
            color: white;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            transition: background-color 0.3s ease;
        }

            .button-danger:hover {
                background-color: #c82333;
            }

        .input-field, .select-field {
            border: 1px solid #ced4da;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            background-color: white; /* Ensure select has a background */
        }

            .input-field:focus, .select-field:focus {
                border-color: #FF7043;
                outline: 0;
                box-shadow: 0 0 0 0.2rem rgba(255, 112, 67, 0.25);
            }

        .day-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px dashed #ddd;
        }

            .day-section:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

        .day-title {
            color: #FF7043;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

            .modal-overlay.active {
                opacity: 1;
                visibility: visible;
            }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #777;
        }
    </style>
</head>
<body>
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a class="text-2xl font-bold text-[#FF7043]" href="index.html">Orlando Adventure Planner</a>
            <a class="nav-item text-gray-700 hidden md:block" href="index.html">‚Üê Back to Main Page</a>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-[#FF7043]">Create Your Orlando Itinerary</h1>
            <p class="text-lg text-gray-600 mt-2">Plan your perfect multi-day trip, step by step!</p>
        </header>

        <section class="mb-10 p-6 bg-white rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">1. Itinerary Details</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label for="itineraryName" class="block text-sm font-medium text-gray-700 mb-1">Itinerary Name</label>
                    <input type="text" id="itineraryName" class="input-field" placeholder="e.g., Family Fun Trip 2025">
                </div>
                <div>
                    <label for="itineraryStartDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                    <input type="date" id="itineraryStartDate" class="input-field">
                </div>
                <div>
                    <label for="itineraryNumberOfDays" class="block text-sm font-medium text-gray-700 mb-1">Number of Days</label>
                    <input type="number" id="itineraryNumberOfDays" class="input-field" value="1" min="1" max="30">
                </div>
                <div>
                    <label for="itineraryBudget" class="block text-sm font-medium text-gray-700 mb-1">Overall Budget ($)</label>
                    <input type="number" id="itineraryBudget" class="input-field" placeholder="e.g., 2000" min="0">
                </div>
            </div>
        </section>

        <div class="grid lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                <section class="p-6 bg-white rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-1 text-gray-700">2. Add Predefined Activities</h2>
                    <p class="text-sm text-gray-500 mb-4">Choose from popular Orlando attractions.</p>
                    <div>
                        <label for="selectDayForPredefined" class="block text-sm font-medium text-gray-700 mb-1">Add to Day:</label>
                        <select id="selectDayForPredefined" class="select-field mb-4"></select>
                    </div>
                    <input type="text" id="searchPlannerActivities" class="input-field mb-4" placeholder="Search activities...">
                    <div id="plannerActivitiesList" class="max-h-80 overflow-y-auto space-y-3 pr-2">
                    </div>
                </section>

                <section class="p-6 bg-white rounded-lg shadow-lg">
                    <h2 class="text-2xl font-semibold mb-1 text-gray-700">3. Add Custom Item</h2>
                    <p class="text-sm text-gray-500 mb-4">Add your own places or notes.</p>
                    <form id="customActivityForm" class="space-y-4">
                        <div>
                            <label for="selectDayForCustom" class="block text-sm font-medium text-gray-700">Add to Day:</label>
                            <select id="selectDayForCustom" class="select-field mt-1 mb-3"></select>
                        </div>
                        <div>
                            <label for="customName" class="block text-sm font-medium text-gray-700">Activity Name</label>
                            <input type="text" id="customName" class="input-field mt-1" required placeholder="e.g., Dinner at Resort">
                        </div>
                        <div>
                            <label for="customTime" class="block text-sm font-medium text-gray-700">Time (Optional)</label>
                            <input type="time" id="customTime" class="input-field mt-1">
                        </div>
                        <div>
                            <label for="customCost" class="block text-sm font-medium text-gray-700">Estimated Cost ($)</label>
                            <input type="number" id="customCost" class="input-field mt-1" min="0" placeholder="e.g., 50">
                        </div>
                        <div>
                            <label for="customDescription" class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                            <textarea id="customDescription" rows="2" class="input-field mt-1" placeholder="e.g., Reservation at 7 PM"></textarea>
                        </div>
                        <button type="submit" class="button-primary w-full">Add Custom Item</button>
                    </form>
                </section>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <section class="p-6 bg-white rounded-lg shadow-lg">
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-700">4. Your Itinerary</h2>
                        <div class="flex space-x-2 mt-2 sm:mt-0">
                            <button id="shareItineraryBtn" class="button-secondary text-sm px-3 py-2">üîó Share</button>
                            <button id="clearItineraryBtn" class="button-danger text-sm px-3 py-2">üóëÔ∏è Clear All</button>
                        </div>
                    </div>
                    <div id="itineraryDaysContainer" class="space-y-6">
                        <p class="text-gray-500 italic default-empty-text">Your itinerary is currently empty. Add some activities and set the number of days!</p>
                    </div>
                </section>

                <section class="p-6 bg-white rounded-lg shadow-lg sticky bottom-0 lg:static">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Budget Summary</h2>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Budget:</span>
                            <span id="summaryBudget" class="font-semibold text-gray-800">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Estimated Cost (All Days):</span>
                            <span id="summaryCost" class="font-semibold text-gray-800">$0.00</span>
                        </div>
                        <hr class="my-2">
                        <div class="flex justify-between">
                            <span class="text-lg font-semibold text-gray-700">Remaining Budget:</span>
                            <span id="summaryRemaining" class="text-lg font-bold text-[#FF7043]">$0.00</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        <div class="text-center my-10">
            <a href="index.html">
                <button class="button-primary">
                    üè† Back to Main Adventure Page
                </button>
            </a>
        </div>
    </main>

    <div id="shareModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeShareModal" class="modal-close-button">√ó</button>
            <h3 class="text-2xl font-bold text-[#FF7043] mb-4">Share Your Itinerary</h3>
            <p class="text-gray-600 mb-2">Copy the code below to share your itinerary. Others can load it by pasting this code or using the generated link.</p>
            <textarea id="shareCode" rows="4" class="input-field w-full mb-3" readonly></textarea>
            <button id="copyShareCodeBtn" class="button-primary w-full mb-3">Copy Code</button>
            <p class="text-gray-600 mb-2">Or share this link:</p>
            <input type="text" id="shareLink" class="input-field w-full" readonly>
            <button id="copyShareLinkBtn" class="button-primary w-full mt-2">Copy Link</button>
        </div>
    </div>

    <div id="loadCodeModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeLoadCodeModal" class="modal-close-button">√ó</button>
            <h3 class="text-2xl font-bold text-[#FF7043] mb-4">Load Itinerary from Code</h3>
            <p class="text-gray-600 mb-2">Paste the itinerary code below:</p>
            <textarea id="loadCodeInput" rows="4" class="input-field w-full mb-3" placeholder="Paste code here..."></textarea>
            <button id="loadFromCodeBtn" class="button-primary w-full">Load Itinerary</button>
        </div>
    </div>
    <button id="openLoadCodeModalBtn" class="fixed bottom-4 right-4 button-secondary px-4 py-2 rounded-full shadow-lg">Load from Code</button>


    <script>
        // --- DATA (From index.html, ensure this is kept up-to-date with index.html) ---
        const allActivitiesData = [
            { id: 'leu-gardens', name: 'Harry P. Leu Gardens', category: 'nature_beaches', description: '50-acre botanical oasis...', imageUrl: 'https://www.magicalvacationhomes.com/wp-content/uploads/2020/04/Harry_P_Leu_Gardens_3-1.jpg', websiteUrl: 'https://www.leugardens.org', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Harry+P.+Leu+Gardens+Orlando' },
            { id: 'bok-tower', name: 'Bok Tower Gardens', category: 'nature_beaches', description: 'Peaceful garden and bird sanctuary...', imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/c/c2/Bok_Tower_at_Work.jpg', websiteUrl: 'https://boktowergardens.org', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Bok+Tower+Gardens' },
            { id: 'icon-park', name: 'ICON Park & The Wheel', category: 'entertainment_attractions', description: 'ICON Park features The Wheel...', imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/0/00/ICON_Park_green_overview.jpg', websiteUrl: 'https://iconparkorlando.com', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=ICON+Park+Orlando' },
            { id: 'orlando-museum-art', name: 'Orlando Museum of Art', category: 'entertainment_attractions', description: 'Explore rotating exhibits...', imageUrl: 'https://assets.simpleviewinc.com/simpleview/image/upload/crm/visitflorida/54695_uhmdkn72x58pw6sariech1jdmswa99lv_93a5e430-5056-a36a-0b7d257fc07373d1.jpg', websiteUrl: 'https://omart.org', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Orlando+Museum+of+Art' },
            { id: 'winter-park-boat', name: 'Winter Park Scenic Boat Tour', category: 'leisure', description: 'Relaxing one-hour boat tour...', imageUrl: 'https://www.orlandoattractions.com/2019/wp-content/uploads/2018/04/winter-park-006.jpg', websiteUrl: 'https://scenicboattours.com', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Winter+Park+Scenic+Boat+Tour' },
            { id: 'disney-springs', name: 'Disney Springs', category: 'shopping', description: 'Lively waterfront district...', imageUrl: 'https://images.squarespace-cdn.com/content/v1/54493bfee4b078c86b426a79/1469285147835-IZA866EAOR557K46U91S/DIsney_Springs_Night', websiteUrl: 'https://www.disneysprings.com', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Disney+Springs+Orlando' },
            { id: 'universal-studios', name: 'Universal Studios Florida', category: 'universal_parks', description: 'Step directly into the movies...', imageUrl: 'https://www.themeparkinsider.com/art/reviews/universal-studios-florida.jpg', websiteUrl: 'https://www.universalorlando.com/web/en/us/theme-parks/universal-studios-florida', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Universal+Studios+Florida' },
            { id: 'islands-of-adventure', name: 'Universal Islands of Adventure', category: 'universal_parks', description: 'Unleash your inner adventurer...', imageUrl: 'https://www.themeparkinsider.com/art/reviews/islands-of-adventure.jpg', websiteUrl: 'https://www.universalorlando.com/web/en/us/theme-parks/islands-of-adventure', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Universal+Islands+of+Adventure' },
            { id: 'volcano-bay', name: 'Universal Volcano Bay', category: 'universal_parks', description: 'Escape to a South Pacific paradise...', imageUrl: 'https://www.orlandomagazine.com/content/uploads/2025/02/z/q/universal-volcano-bay-nights-tickets-are-on-sale-now.jpg', websiteUrl: 'https://www.universalorlando.com/web/en/us/theme-parks/volcano-bay', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Universal+Volcano+Bay' },
            { id: 'busch-gardens-safari', name: 'Busch Gardens Tampa Bay & Safari', category: 'other_theme_parks', description: 'Experience thrilling rides and amazing animal encounters...', imageUrl: 'https://s7d2.scene7.com/is/image/TWCNews/0702_bn9_busch_gardens_safari_tour_masks', websiteUrl: 'https://buschgardens.com/tampa/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Busch+Gardens+Tampa+Bay' },
            { id: 'animal-kingdom', name: 'Walt Disney World Animal Kingdom', category: 'other_theme_parks', description: 'Journey into the heart of nature and adventure...', imageUrl: 'https://assets.simpleviewinc.com/simpleview/image/fetch/c_limit,h_1200,q_75,w_1200/https://visitorlando.widen.net/content/4gxkw07ozb/original/2322-view.jpg%3Fposition%3Dc%26crop%3Dyes%26color%3Dffffff%26quality%3D8', websiteUrl: 'https://www.disneyworld.disney.go.com/destinations/animal-kingdom/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Disney+Animal+Kingdom' },
            { id: 'gatorland', name: 'Gatorland', category: 'other_theme_parks', description: 'Dubbed the "Alligator Capital of the World"...', imageUrl: 'https://res.cloudinary.com/dtljonz0f/image/upload/f_auto/q_auto/v1/gc-v1/orlando/gatorland_orlando_11_cvfpey?_a=BAVAZGE70', websiteUrl: 'https://www.gatorland.com', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Gatorland+Orlando' },
            { id: 'discovery-cove', name: 'Discovery Cove', category: 'other_theme_parks', description: 'Discovery Cove is an all-inclusive day resort...', imageUrl: 'https://discoverycove.com/orlando/-/media/migrated-media/discovery-cove-orlando/images/heroes/generic/1024x530-dco-2022-park-scope.jpg?h=530&w=1024&la=en&hash=E5FE846C78F2488733D9AB2BDB6B537B', websiteUrl: 'https://www.discoverycove.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Discovery+Cove+Orlando' },
            { id: 'everglades', name: 'Everglades National Park', category: 'nature_beaches', description: 'Discover the unique ecosystem of the Everglades...', imageUrl: 'https://cdn.britannica.com/92/130792-050-ED0EFC61/Everglades-National-Park-Florida.jpg', websiteUrl: 'https://www.nps.gov/ever/index.htm', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Everglades+National+Park' },
            { id: 'coco-beach', name: 'Cocoa Beach', category: 'nature_beaches', description: 'Enjoy a classic Florida beach day at Cocoa Beach...', imageUrl: 'https://www.wildlifewatersports.com/wp-content/uploads/2021/06/cocoa-beach-pier.png', websiteUrl: 'https://www.visitcocoabeach.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Cocoa+Beach+Florida' },
            { id: 'clearwater', name: 'Clearwater Beach', category: 'nature_beaches', description: 'Discover the stunning white sands...', imageUrl: 'https://s42949.pcdn.co/wp-content/uploads/2023/01/Gray-Line-Orlando-Clearwater-Beach-Promenade-banner.jpeg', websiteUrl: 'https://www.visitclearwaterflorida.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Clearwater+Beach+Florida' },
            { id: 'lakes', name: 'Orlando Lakes', category: 'nature_beaches', description: 'Orlando is home to numerous beautiful lakes...', imageUrl: 'https://www.orlando.gov/files/oc-templates/00000000-0000-0000-0000-000000000000/7d7464b8-f248-4433-b870-efe915aca122/v/3570/082018_lakeeola_skyline2-min-min.jpg?t=638821780570787311', websiteUrl: 'https://www.google.com/search?q=lakes+in+orlando+florida', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Orlando+Lakes' },
            { id: 'kennedy-space-center', name: 'Kennedy Space Center Visitor Complex', category: 'entertainment_attractions', description: 'Blast off on an educational journey...', imageUrl: 'https://cdn-imgix.headout.com/microbrands-content-image/image/d064b834bebab22aeda3a22b9f631f20-Kennedy%20Space%20Center.jpg?auto=format&w=1069.6000000000001&h=687.6&q=90&ar=14%3A9&crop=faces&fit=crop', websiteUrl: 'https://www.kennedyspacecenter.com', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Kennedy+Space+Center+Visitor+Complex' },
            { id: 'canyon-zip-line', name: 'Canyon Zip Line and Adventure Park', category: 'entertainment_attractions', description: 'Soar through the skies...', imageUrl: 'https://www.ocalamarion.com/imager/files_idss_com/C201/d57ea4e6-b814-4970-a280-3528e18c6f8f_e45adf5f6bc0c5c2a30a39868f44eab6.jpg', websiteUrl: 'https://www.zipthecanyons.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Canyon+Zip+Line+and+Adventure+Park+Ocala' },
            { id: 'old-town', name: 'Old Town & Old Town Car Night', category: 'entertainment_attractions', description: 'Step back in time at Old Town...', imageUrl: 'https://visitorlando.widen.net/content/84rbyer2ku/jpeg/184117-street-overview.jpg?crop=false&position=c&q=80&color=ffffffff&u=kggsuk', websiteUrl: 'https://www.myoldtownusa.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Old+Town+Kissimmee' },
            { id: 'chillis', name: "Chilli's Grill & Bar", category: 'food_stays', description: "Chilli's Grill & Bar is a popular casual dining restaurant...", imageUrl: 'https://imageio.forbes.com/specials-images/imageserve/66478e8231a9ad04b16e8d76/Florida--Orlando--Chili-s-Grill---Bar--restaurant-entrance/0x0.jpg?crop=2035,1145,x0,y0,safe&height=400&width=711&fit=bounds', websiteUrl: 'https://www.chilis.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Chilis+Grill+Bar+Orlando' },
            { id: 'longhorns', name: 'Longhorn Steakhouse', category: 'food_stays', description: 'Longhorn Steakhouse offers a classic steakhouse experience...', imageUrl: 'https://media.cntraveler.com/photos/5c05c8193ffe425069ff752b/master/w_1200,c_limit/LongHorn-Steakhouse_2018_0037-FlovalNewYorkStrip_2018.jpg', websiteUrl: 'https://www.longhornsteakhouse.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Longhorn+Steakhouse+Orlando' },
            { id: 'carlos-bakery-cakes', name: "Carlo's Bakery Cakes", category: 'food_stays', description: 'Famous from the TV show "Cake Boss"...', imageUrl: 'https://assets.simpleviewinc.com/simpleview/image/upload/c_limit,h_1200,q_75,w_1200/v1/clients/orlandofl/7891_carlos_entrance_94dcacd4-10be-4826-b311-7e2d36624e7f.jpg', websiteUrl: 'https://www.carlosbakery.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Carlos+Bakery+Orlando' },
            { id: 'floridays', name: 'Floridays Resort Orlando', category: 'food_stays', description: 'Floridays Resort Orlando offers spacious suites...', imageUrl: 'https://content.tui.co.uk/adamtui/2023_1/31_15/67d26d2d-bf84-4f91-bd31-af9b00fbd8a8/ACC_034385_FLO_12WebOriginalCompressed.jpg?i10c=img.resize(width:1080);img.crop(width:1080%2Cheight:608)', websiteUrl: 'https://www.floridaysresortorlando.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Floridays+Resort+Orlando' },
            { id: 'sonesta', name: 'Sonesta ES Suites Orlando', category: 'food_stays', description: 'Sonesta ES Suites Orlando provides all-suite accommodations...', imageUrl: 'https://images.trvl-media.com/lodging/1000000/30000/26800/26711/7d99a9d2.jpg?impolicy=resizecrop&rw=575&rh=575&ra=fill', websiteUrl: 'https://www.sonesta.com/sonesta-es-suites/orlando/international-drive', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Sonesta+ES+Suites+Orlando+International+Drive' },
            { id: 'westgates-lakes', name: 'Westgate Lakes Resort & Spa', category: 'food_stays', description: 'Westgate Lakes Resort & Spa is a sprawling lakefront resort...', imageUrl: 'https://dlq00ggnjruqn.cloudfront.net/prometheus/getImage?id=347158&width=865&height=490', websiteUrl: 'https://www.westgateresorts.com/hotels/florida/orlando/westgate-lakes-resort-spa/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Westgate+Lakes+Resort+Spa+Orlando' },
            { id: 'marriotts-grande-vista', name: "Marriott's Grande Vista", category: 'food_stays', description: "A family-friendly vacation ownership resort in Orlando...", imageUrl: 'https://dynamic-media-cdn.tripadvisor.com/media/photo-o/29/04/98/61/marriott-s-grande-vista.jpg?w=1200&h=-1&s=1', websiteUrl: 'https://www.marriott.com/en-us/hotels/mcogv-marriotts-grande-vista/overview/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Marriotts+Grande+Vista+Orlando' },
            { id: 'sheraton-vistana-villages', name: "Sheraton Vistana Villages Resort Villas, I-Drive/Orlando", category: 'food_stays', description: "A vacation ownership resort on International Drive...", imageUrl: 'https://www.marriott.com/content/dam/marriott-digital/marriott-vacation-club/vc/master/hero/sisf-hero-vistana-villages-pool-3840x1650.jpg', websiteUrl: 'https://www.marriott.com/en-us/hotels/mcose-sheraton-vistana-villages-resort-villas-i-drive-orlando/overview/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Sheraton+Vistana+Villages+Resort+Villas+Orlando' },
            { id: 'cars-for-hire', name: 'Cars for Hire in Orlando', category: 'leisure', description: 'Various car rental options are available...', imageUrl: 'https://i.ytimg.com/vi/WzNJ3iF1i84/hq720.jpg?sqp=-oaymwEhCK4FEIIDSFryq4qpAxMIARUAAAAAGAElAADIQj0AgKJD&rs=AOn4CLBnMWZ6Ss-K1hL3urWjVl5aQbpOHg', websiteUrl: 'https://www.avis.com/en/locations/us/fl/orlando', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Car+Rental+Orlando' },
            { id: 'premium-outlets', name: 'Orlando Premium Outlets', category: 'shopping', description: 'Orlando is home to two massive Premium Outlets...', imageUrl: 'https://assets.simon.com/propertyimages/874/orlando-premium-outlets-15.jpg', websiteUrl: 'https://www.premiumoutlets.com/outlet/orlando-vineland', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Orlando+Premium+Outlets' },
            { id: 'florida-mall', name: 'The Florida Mall', category: 'shopping', description: "One of Central Florida's largest indoor shopping destinations...", imageUrl: 'https://visitorlando.widen.net/content/3nm9gzscc4/original/7891-shake-shack-exterior.jpg?position=c&crop=yes&color=ffffff&quality=8', websiteUrl: 'https://www.simon.com/mall/the-florida-mall', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=The+Florida+Mall+Orlando' },
            { id: 'millenia-mall', name: 'Mall at Millenia', category: 'shopping', description: 'For an upscale shopping experience...', imageUrl: 'https://visitorlando.widen.net/content/ivbztf1zd8/jpeg/7893-main-entrance2.jpg?crop=false&position=c&q=80&color=ffffffff&u=kggsuk', websiteUrl: 'https://www.mallatmillenia.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Mall+at+Millenia+Orlando' },
            { id: 'east-end-market', name: 'East End Market', category: 'shopping', description: 'East End Market is a vibrant neighborhood market...', imageUrl: 'https://assets.simpleviewinc.com/simpleview/image/upload/c_fill,f_jpg,g_xy_center,h_427,q_65,w_640,x_2282,y_1948/v1/clients/orlandofl/Downtown_Orlando_com_east_end_market_sign_dsc_2350_ca3096ed-50c1-470a-9095-2a9cf3fd8127.jpg', websiteUrl: 'https://eastendmkt.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=East+End+Market+Orlando' },
            { id: 'pirates-cove-golf', name: "Pirate's Cove Adventure Golf (I-Drive)", category: 'leisure', description: 'Voted "Best in Florida"...', imageUrl: 'https://www.piratescove.net/media/uploads/locationpage-slides/orlando/2024/*dsc02567.jpg', websiteUrl: 'https://www.piratescove.com/locations/orlando-international-drive/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Pirates+Cove+Adventure+Golf+International+Drive+Orlando' },
            { id: 'hollywood-drive-in-golf', name: 'Hollywood Drive-In Golf (CityWalk)', category: 'leisure', description: 'Play through two themed 18-hole courses...', imageUrl: 'https://orlandoinformer.com/wp-content/uploads/2022/10/Hollywood-Drive-In-Golf-CityWalk.jpg', websiteUrl: 'https://www.hollywooddriveingolf.com/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Hollywood+Drive+In+Golf+Universal+CityWalk+Orlando' },
            { id: 'fun-spot-go-karts', name: 'Fun Spot America Go Karts', category: 'leisure', description: 'Experience multi-level go-kart tracks...', imageUrl: 'https://fun-spot.com/wp-content/uploads/2015/04/quadhelix.jpg', websiteUrl: 'https://fun-spot.com/orlando/orlando-go-karts/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Fun+Spot+America+Go+Karts+Orlando' },
            { id: 'dezerland-go-karts', name: 'Dezerland Park Go Karts', category: 'leisure', description: "Race on Florida's longest indoor go-kart track...", imageUrl: 'https://dezerlandpark.com/wp-content/uploads/2024/04/Karting-Page.jpg', websiteUrl: 'https://dezerlandpark.com/attractions/karting-orlando/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Dezerland+Park+Go+Karts+Orlando' },
            { id: 'shooting', name: 'Shooting Ranges in Orlando', category: 'leisure', description: 'For those interested in target shooting...', imageUrl: 'https://zamalektours.com/wp-content/uploads/2023/11/Shooting-Range.jpg', websiteUrl: 'https://myfwc.com/hunting/safety-education/shooting-ranges/', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Shooting+Ranges+Orlando' },
            { id: 'quad-biking', name: 'Quad Biking (ATV) Adventures', category: 'leisure', description: 'Experience the thrill of off-road adventure...', imageUrl: 'https://www.attractiontickets.com/sites/default/files/styles/photo_grid_other/public/2020-02/ATV-Experience-2.jpg.jpg?itok=KWJknd4w', websiteUrl: 'https://www.google.com/search?q=quad+biking+tours+orlando', googleMapsUrl: 'https://www.google.com/maps/search/?api=1&query=Quad+Biking+Orlando' }
        ];

        // --- DOM Elements ---
        const itineraryNameEl = document.getElementById('itineraryName');
        const itineraryStartDateEl = document.getElementById('itineraryStartDate');
        const itineraryNumberOfDaysEl = document.getElementById('itineraryNumberOfDays');
        const itineraryBudgetEl = document.getElementById('itineraryBudget');

        const selectDayForPredefinedEl = document.getElementById('selectDayForPredefined');
        const selectDayForCustomEl = document.getElementById('selectDayForCustom');

        const plannerActivitiesListEl = document.getElementById('plannerActivitiesList');
        const searchPlannerActivitiesEl = document.getElementById('searchPlannerActivities');

        const customActivityForm = document.getElementById('customActivityForm');
        const customNameEl = document.getElementById('customName');
        const customTimeEl = document.getElementById('customTime');
        const customCostEl = document.getElementById('customCost');
        const customDescriptionEl = document.getElementById('customDescription');

        const itineraryDaysContainerEl = document.getElementById('itineraryDaysContainer');
        const summaryBudgetEl = document.getElementById('summaryBudget');
        const summaryCostEl = document.getElementById('summaryCost');
        const summaryRemainingEl = document.getElementById('summaryRemaining');

        const shareItineraryBtn = document.getElementById('shareItineraryBtn');
        const clearItineraryBtn = document.getElementById('clearItineraryBtn');

        const shareModal = document.getElementById('shareModal');
        const closeShareModalBtn = document.getElementById('closeShareModal');
        const shareCodeEl = document.getElementById('shareCode');
        const copyShareCodeBtn = document.getElementById('copyShareCodeBtn');
        const shareLinkEl = document.getElementById('shareLink');
        const copyShareLinkBtn = document.getElementById('copyShareLinkBtn');

        const loadCodeModal = document.getElementById('loadCodeModal');
        const openLoadCodeModalBtn = document.getElementById('openLoadCodeModalBtn');
        const closeLoadCodeModalBtn = document.getElementById('closeLoadCodeModal');
        const loadCodeInputEl = document.getElementById('loadCodeInput');
        const loadFromCodeBtn = document.getElementById('loadFromCodeBtn');


        // --- State ---
        let itinerary = {
            name: '',
            startDate: '',
            numberOfDays: 1,
            budget: 0,
            items: []
        };
        // Variables to store the last selected day for each dropdown
        let lastSelectedPredefinedDay = 1;
        let lastSelectedCustomDay = 1;


        // --- Functions ---

        function formatCurrency(amount) {
            return `$${parseFloat(amount || 0).toFixed(2)}`;
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function updateDaySelectorDropdowns() {
            const numDays = parseInt(itineraryNumberOfDaysEl.value) || 1;

            // Store current selections before clearing, if they exist
            const currentPredefinedDay = selectDayForPredefinedEl.value ? parseInt(selectDayForPredefinedEl.value) : lastSelectedPredefinedDay;
            const currentCustomDay = selectDayForCustomEl.value ? parseInt(selectDayForCustomEl.value) : lastSelectedCustomDay;

            selectDayForPredefinedEl.innerHTML = '';
            selectDayForCustomEl.innerHTML = '';

            if (numDays <= 0) {
                const defaultOption = document.createElement('option');
                defaultOption.value = "1";
                defaultOption.textContent = "Day 1";
                selectDayForPredefinedEl.appendChild(defaultOption.cloneNode(true));
                selectDayForCustomEl.appendChild(defaultOption);
                lastSelectedPredefinedDay = 1; // Reset stored day
                lastSelectedCustomDay = 1;    // Reset stored day
                return;
            }

            for (let i = 1; i <= numDays; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Day ${i}`;
                selectDayForPredefinedEl.appendChild(option.cloneNode(true));
                selectDayForCustomEl.appendChild(option.cloneNode(true)); // Use cloneNode here too
            }

            // Restore last selected day if still valid, otherwise default to 1 or max
            lastSelectedPredefinedDay = Math.min(Math.max(1, currentPredefinedDay), numDays);
            lastSelectedCustomDay = Math.min(Math.max(1, currentCustomDay), numDays);

            selectDayForPredefinedEl.value = lastSelectedPredefinedDay;
            selectDayForCustomEl.value = lastSelectedCustomDay;
        }


        function saveItinerary() {
            itinerary.name = itineraryNameEl.value;
            itinerary.startDate = itineraryStartDateEl.value;
            itinerary.numberOfDays = parseInt(itineraryNumberOfDaysEl.value) || 1;
            itinerary.budget = parseFloat(itineraryBudgetEl.value) || 0;

            localStorage.setItem('orlandoItinerary', JSON.stringify(itinerary));
            renderItinerary();
            updateBudgetSummary();
            updateDaySelectorDropdowns();
        }

        function loadItinerary() {
            const savedItinerary = localStorage.getItem('orlandoItinerary');
            if (savedItinerary) {
                const parsedItinerary = JSON.parse(savedItinerary);
                itinerary = {
                    name: parsedItinerary.name || '',
                    startDate: parsedItinerary.startDate || parsedItinerary.date || '',
                    numberOfDays: parsedItinerary.numberOfDays || 1,
                    budget: parsedItinerary.budget || 0,
                    items: parsedItinerary.items || []
                };

                itineraryNameEl.value = itinerary.name;
                itineraryStartDateEl.value = itinerary.startDate;
                itineraryNumberOfDaysEl.value = itinerary.numberOfDays;
                itineraryBudgetEl.value = itinerary.budget;

                itinerary.items.forEach(item => {
                    if (item.day === undefined) {
                        item.day = 1;
                    }
                });
                // After loading number of days, ensure lastSelected days are valid
                lastSelectedPredefinedDay = Math.min(Math.max(1, lastSelectedPredefinedDay), itinerary.numberOfDays);
                lastSelectedCustomDay = Math.min(Math.max(1, lastSelectedCustomDay), itinerary.numberOfDays);

            }
            updateDaySelectorDropdowns();
            renderItinerary();
            updateBudgetSummary();
        }

        function renderPlannerActivities(filterText = '') {
            plannerActivitiesListEl.innerHTML = '';
            const filteredActivities = allActivitiesData.filter(activity =>
                activity.name.toLowerCase().includes(filterText.toLowerCase())
            );

            if (filteredActivities.length === 0) {
                plannerActivitiesListEl.innerHTML = `<p class="text-gray-500 italic">No activities found.</p>`;
                return;
            }

            filteredActivities.forEach(activity => {
                const div = document.createElement('div');
                div.className = 'p-3 border rounded-md bg-gray-50 hover:bg-gray-100';
                div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-sm">${activity.name}</h4>
                                <p class="text-xs text-gray-500">${activity.category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                            </div>
                            <button data-id="${activity.id}" class="add-planner-item-btn text-xs bg-[#FF7043] text-white px-2 py-1 rounded hover:bg-orange-600">Add</button>
                        </div>
                        <input type="number" class="planner-item-cost-input input-field text-sm mt-2 w-full" placeholder="Est. Cost ($)" min="0">
                        <input type="time" class="planner-item-time-input input-field text-sm mt-1 w-full">
                    `;
                plannerActivitiesListEl.appendChild(div);
            });

            document.querySelectorAll('.add-planner-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const activityId = e.target.dataset.id;
                    const activityData = allActivitiesData.find(a => a.id === activityId);
                    const parentDiv = e.target.closest('.p-3');
                    const costInput = parentDiv.querySelector('.planner-item-cost-input');
                    const timeInput = parentDiv.querySelector('.planner-item-time-input');

                    const cost = parseFloat(costInput.value) || 0;
                    const time = timeInput.value || '';
                    const selectedDay = parseInt(selectDayForPredefinedEl.value); // Use the current value

                    if (activityData && selectedDay) {
                        itinerary.items.push({
                            id: generateUniqueId(),
                            type: 'planner',
                            name: activityData.name,
                            time: time,
                            cost: cost,
                            description: activityData.description.split('.')[0] + '.',
                            plannerActivityId: activityData.id,
                            day: selectedDay
                        });
                        costInput.value = '';
                        timeInput.value = '';
                        saveItinerary();
                    } else if (!selectedDay) {
                        alert("Please select a day to add the activity to.");
                    }
                });
            });
        }

        function handleCustomActivitySubmit(event) {
            event.preventDefault();
            const name = customNameEl.value;
            const time = customTimeEl.value;
            const cost = parseFloat(customCostEl.value) || 0;
            const description = customDescriptionEl.value;
            const selectedDay = parseInt(selectDayForCustomEl.value); // Use the current value

            if (!name) {
                alert("Please enter a name for the custom activity.");
                return;
            }
            if (!selectedDay) {
                alert("Please select a day to add the custom item to.");
                return;
            }

            itinerary.items.push({
                id: generateUniqueId(),
                type: 'custom',
                name: name,
                time: time,
                cost: cost,
                description: description,
                day: selectedDay
            });

            // Only reset form fields, not the day selector implicitly
            customNameEl.value = '';
            customTimeEl.value = '';
            customCostEl.value = '';
            customDescriptionEl.value = '';
            // customActivityForm.reset(); // This might reset the select, avoid if explicitly managing select value

            saveItinerary();
        }

        function renderItinerary() {
            itineraryDaysContainerEl.innerHTML = '';
            const numDays = parseInt(itineraryNumberOfDaysEl.value) || 0;

            if (numDays === 0 || itinerary.items.length === 0) {
                let emptyTextEl = itineraryDaysContainerEl.querySelector('.default-empty-text');
                if (!emptyTextEl) {
                    emptyTextEl = document.createElement('p');
                    emptyTextEl.className = 'text-gray-500 italic default-empty-text';
                    itineraryDaysContainerEl.appendChild(emptyTextEl);
                }
                if (numDays === 0 && itinerary.items.length === 0) { // Show this only if no days and no items
                    emptyTextEl.textContent = "Please set the number of days for your itinerary.";
                } else if (itinerary.items.length === 0) { // If days are set but no items
                    emptyTextEl.textContent = "Your itinerary is currently empty. Add some activities!";
                } else if (numDays === 0 && itinerary.items.length > 0) { // If items exist but days set to 0 (should not happen with validation)
                    emptyTextEl.textContent = "Please set a valid number of days to see your items.";
                } else {
                    // This case should ideally not be reached if logic is correct, but as a fallback:
                    emptyTextEl.textContent = "Your itinerary is currently empty or number of days is not set.";
                }
                updateBudgetSummary();
                return;
            }


            for (let i = 1; i <= numDays; i++) {
                const daySectionEl = document.createElement('div');
                daySectionEl.className = 'day-section';

                const dayTitleEl = document.createElement('h3');
                dayTitleEl.className = 'day-title';
                dayTitleEl.textContent = `Day ${i}`;
                daySectionEl.appendChild(dayTitleEl);

                const itemsForDay = itinerary.items
                    .filter(item => item.day === i)
                    .sort((a, b) => {
                        if (a.time && b.time) return a.time.localeCompare(b.time);
                        if (a.time) return -1;
                        if (b.time) return 1;
                        return 0;
                    });

                if (itemsForDay.length === 0) {
                    const noItemsEl = document.createElement('p');
                    noItemsEl.className = 'text-gray-500 italic text-sm';
                    noItemsEl.textContent = 'No activities planned for this day.';
                    daySectionEl.appendChild(noItemsEl);
                } else {
                    itemsForDay.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-4 border rounded-lg bg-white shadow mb-3';
                        itemEl.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-semibold text-md text-[#FF7043]">${item.name}</h4>
                                        ${item.time ? `<p class="text-xs text-gray-600">Time: ${item.time}</p>` : ''}
                                        <p class="text-xs text-gray-600">Cost: ${formatCurrency(item.cost)}</p>
                                        ${item.description ? `<p class="text-xs text-gray-500 mt-1">${item.description}</p>` : ''}
                                    </div>
                                    <button data-id="${item.id}" class="remove-item-btn button-danger text-xs px-2 py-1">Remove</button>
                                </div>
                            `;
                        daySectionEl.appendChild(itemEl);
                    });
                }
                itineraryDaysContainerEl.appendChild(daySectionEl);
            }

            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.id;
                    itinerary.items = itinerary.items.filter(item => item.id !== itemId);
                    saveItinerary();
                });
            });
            updateBudgetSummary();
        }


        function updateBudgetSummary() {
            const totalBudget = parseFloat(itineraryBudgetEl.value) || 0;
            const totalCost = itinerary.items.reduce((sum, item) => sum + (item.cost || 0), 0);
            const remainingBudget = totalBudget - totalCost;

            summaryBudgetEl.textContent = formatCurrency(totalBudget);
            summaryCostEl.textContent = formatCurrency(totalCost);
            summaryRemainingEl.textContent = formatCurrency(remainingBudget);

            if (remainingBudget < 0) {
                summaryRemainingEl.classList.remove('text-[#FF7043]');
                summaryRemainingEl.classList.add('text-red-600');
            } else {
                summaryRemainingEl.classList.add('text-[#FF7043]');
                summaryRemainingEl.classList.remove('text-red-600');
            }
        }

        function clearItinerary() {
            const userConfirmed = window.confirm("Are you sure you want to clear the entire itinerary? This cannot be undone.");
            if (userConfirmed) {
                itinerary = {
                    name: '',
                    startDate: '',
                    numberOfDays: 1,
                    budget: 0,
                    items: []
                };
                itineraryNameEl.value = '';
                itineraryStartDateEl.value = '';
                itineraryNumberOfDaysEl.value = '1';
                itineraryBudgetEl.value = '';
                lastSelectedPredefinedDay = 1; // Reset stored day
                lastSelectedCustomDay = 1;    // Reset stored day
                saveItinerary();
            }
        }


        function generateShareCode() {
            itinerary.name = itineraryNameEl.value;
            itinerary.startDate = itineraryStartDateEl.value;
            itinerary.numberOfDays = parseInt(itineraryNumberOfDaysEl.value) || 1;
            itinerary.budget = parseFloat(itineraryBudgetEl.value) || 0;
            const dataStr = JSON.stringify(itinerary);
            return btoa(dataStr);
        }

        function loadFromShareCode(code) {
            try {
                const decodedStr = atob(code);
                const loadedData = JSON.parse(decodedStr);

                if (loadedData && loadedData.items !== undefined && loadedData.numberOfDays !== undefined) {
                    itinerary = {
                        name: loadedData.name || '',
                        startDate: loadedData.startDate || '',
                        numberOfDays: loadedData.numberOfDays || 1,
                        budget: loadedData.budget || 0,
                        items: loadedData.items || []
                    };

                    itinerary.items.forEach(item => {
                        if (item.day === undefined || item.day < 1 || item.day > itinerary.numberOfDays) {
                            item.day = 1;
                        }
                    });

                    itineraryNameEl.value = itinerary.name;
                    itineraryStartDateEl.value = itinerary.startDate;
                    itineraryNumberOfDaysEl.value = itinerary.numberOfDays;
                    itineraryBudgetEl.value = itinerary.budget;

                    lastSelectedPredefinedDay = 1; // Reset on load
                    lastSelectedCustomDay = 1;   // Reset on load

                    saveItinerary();
                    showModalMessage("Itinerary loaded successfully!");

                    return true;
                } else {
                    showModalMessage("Invalid itinerary code structure. Could not load.");
                }
            } catch (error) {
                console.error("Failed to load itinerary from code:", error);
                showModalMessage("Invalid or corrupted itinerary code. Could not load.");
            }
            return false;
        }

        function loadFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareData = urlParams.get('data');
            if (shareData) {
                if (loadFromShareCode(shareData)) {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        function showModalMessage(message, isConfirmation = false, onConfirm = null) {
            if (isConfirmation) {
                if (window.confirm(message)) {
                    if (onConfirm) onConfirm();
                }
            } else {
                alert(message);
            }
        }


        // --- Event Listeners ---
        itineraryNameEl.addEventListener('change', saveItinerary);
        itineraryStartDateEl.addEventListener('change', saveItinerary);
        itineraryNumberOfDaysEl.addEventListener('change', () => {
            const numDays = parseInt(itineraryNumberOfDaysEl.value) || 1;
            if (numDays < 1) itineraryNumberOfDaysEl.value = 1;
            if (numDays > 30) itineraryNumberOfDaysEl.value = 30;
            itinerary.numberOfDays = parseInt(itineraryNumberOfDaysEl.value);

            // Validate and adjust lastSelectedDay variables
            lastSelectedPredefinedDay = Math.min(lastSelectedPredefinedDay, itinerary.numberOfDays);
            lastSelectedCustomDay = Math.min(lastSelectedCustomDay, itinerary.numberOfDays);

            updateDaySelectorDropdowns(); // This will now use the potentially adjusted lastSelectedDay
            saveItinerary();
        });
        itineraryBudgetEl.addEventListener('input', saveItinerary);

        selectDayForPredefinedEl.addEventListener('change', (e) => {
            lastSelectedPredefinedDay = parseInt(e.target.value);
        });
        selectDayForCustomEl.addEventListener('change', (e) => {
            lastSelectedCustomDay = parseInt(e.target.value);
        });


        searchPlannerActivitiesEl.addEventListener('input', (e) => renderPlannerActivities(e.target.value));
        customActivityForm.addEventListener('submit', handleCustomActivitySubmit);
        clearItineraryBtn.addEventListener('click', clearItinerary);

        shareItineraryBtn.addEventListener('click', () => {
            const code = generateShareCode();
            shareCodeEl.value = code;
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('data', code);
            shareLinkEl.value = currentUrl.toString();
            shareModal.classList.add('active');
        });

        closeShareModalBtn.addEventListener('click', () => shareModal.classList.remove('active'));
        shareModal.addEventListener('click', (e) => {
            if (e.target === shareModal) shareModal.classList.remove('active');
        });

        copyShareCodeBtn.addEventListener('click', () => {
            shareCodeEl.select();
            try {
                document.execCommand('copy');
                showModalMessage('Share code copied to clipboard!');
            } catch (err) {
                showModalMessage('Failed to copy code. Please copy manually.');
                console.error('Fallback: Oops, unable to copy', err);
            }
        });
        copyShareLinkBtn.addEventListener('click', () => {
            shareLinkEl.select();
            try {
                document.execCommand('copy');
                showModalMessage('Share link copied to clipboard!');
            } catch (err) {
                showModalMessage('Failed to copy link. Please copy manually.');
                console.error('Fallback: Oops, unable to copy', err);
            }
        });


        openLoadCodeModalBtn.addEventListener('click', () => loadCodeModal.classList.add('active'));
        closeLoadCodeModalBtn.addEventListener('click', () => loadCodeModal.classList.remove('active'));
        loadCodeModal.addEventListener('click', (e) => {
            if (e.target === loadCodeModal) loadCodeModal.classList.remove('active');
        });
        loadFromCodeBtn.addEventListener('click', () => {
            const code = loadCodeInputEl.value.trim();
            if (code) {
                if (loadFromShareCode(code)) {
                    loadCodeInputEl.value = '';
                    loadCodeModal.classList.remove('active');
                }
            } else {
                showModalMessage("Please paste a code to load.");
            }
        });


        // --- Initial Load ---
        loadFromUrl();
        if (!new URLSearchParams(window.location.search).has('data')) {
            loadItinerary();
        }
        updateDaySelectorDropdowns(); // This will now use the potentially loaded lastSelectedDay values
        renderPlannerActivities();
        renderItinerary();

    </script>
</body>
</html>
